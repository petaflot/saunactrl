<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sauna Control</title>
  <style>
    body { font-family: sans-serif; }
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input {
      display: none;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: 0.4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      left: 4px; bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    /* Mode colors */
    .switch.on .slider { background-color: #4CAF50; }
    .switch.off .slider { background-color: #ccc; }
    .switch.on-pending .slider { background-color: #ABFFBA; }
    .switch.off-pending .slider { background-color: #FFBCAB; }
    .switch.on-expired .slider { background-color: #ABFFBA; }
    .switch.off-expired .slider { background-color: #FFBCAB; }
    .switch.modeUnknown .slider { background-color: #ccc; }

    /* Dot positions */
    .switch.on .slider:before,
    .switch.on-pending .slider:before,
    .switch.on-expired .slider:before { transform: translateX(26px); }

    /* Dot sizes */
    .switch.on .slider:before,
    .switch.off .slider:before {
      height: 26px; width: 26px; visibility: visible;
    }
    .switch.on-pending .slider:before,
    .switch.off-pending .slider:before {
      height: 13px; width: 13px; top: 10px; left: 10px;
    }
    .switch.on-pending .slider:before { transform: translateX(26px); }
    .switch.on-expired .slider:before,
    .switch.off-expired .slider:before {
      height: 8px; width: 8px; top: 13px; left: 13px;
    }
    .switch.on-expired .slider:before { transform: translateX(26px); }
    .switch.modeUnknown .slider:before { visibility: hidden; }

    /* Text colors */
    .status { font-weight: bold; margin-left: 10px; }
    .modeUnknown { color: gray; }
    .on { color: green; }
    .off { color: red; }
    .pending { color: orange; }
    .expired { color: darkred; }
 

    .v-switch {
      position: relative;
      width: 40px;
      height: 120px;
      background: #ccc;
      border-radius: 20px;
      margin: 20px;
    }
    .knob {
      position: absolute;
      left: 5px;
      width: 30px;
      height: 30px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .v-switch.on      { background: #4CAF50; }
    .v-switch.pid     { background: #2196F3; }
    .v-switch.off     { background: #f44336; }
    .v-switch.modeUnknown { background: #999; }

    .v-switch.on .knob      { top: 5px; }
    .v-switch.pid .knob     { top: 45px; }
    .v-switch.off .knob     { top: 85px; }
    .v-switch.modeUnknown .knob { top: 45px; visibility: hidden; }
  </style>
  <script>
    let ws;
    let lastUpdate = 0;
    let watchdogTimer;
    let mode = "modeUnknown";

    function cycleRelay(relay) {
  const el = document.getElementById("relay" + relay);
  const modes = ["on", "pid", "off"];
  let idx = modes.indexOf(el.dataset.mode || "pid");
  idx = (idx + 1) % modes.length;
  let newMode = modes[idx];
  el.dataset.mode = newMode;
  ws.send("relay:" + relay + ":" + newMode);
}


    function setMode(newMode) {
      mode = newMode;
      const statusEl = document.getElementById("status");
      const toggleWrap = document.getElementById("powerWrap");

      toggleWrap.className = "switch " + mode;

      switch (mode) {
        case "modeUnknown":
          statusEl.textContent = "Unknown";
          statusEl.className = "status modeUnknown";
          break;
        case "on":
          statusEl.textContent = "On";
          statusEl.className = "status on";
          break;
        case "off":
          statusEl.textContent = "Off";
          statusEl.className = "status off";
          break;
        case "on-pending":
          statusEl.textContent = "On (pending)";
          statusEl.className = "status pending";
          break;
        case "off-pending":
          statusEl.textContent = "Off (pending)";
          statusEl.className = "status pending";
          break;
        case "on-expired":
          statusEl.textContent = "On (expired)";
          statusEl.className = "status expired";
          break;
        case "off-expired":
          statusEl.textContent = "Off (expired)";
          statusEl.className = "status expired";
          break;
      }
    }

    function formatElapsed(ms) {
      const s = Math.floor(ms / 1000);
      const h = Math.floor(s / 3600);
      const m = Math.floor((s % 3600) / 60);
      const sec = s % 60;
      return `${h}h ${m}m ${sec}s`;
    }

    function refreshWatchdog() {
      clearInterval(watchdogTimer);

      watchdogTimer = setInterval(() => {
        if (!lastUpdate) return;

        const now = Date.now();
        const elapsed = now - lastUpdate;
        const s = Math.floor(elapsed / 1000);
        const watchdogInfo = document.getElementById("watchdog");

        if (s < 60) {
          watchdogInfo.textContent = `(updated ${formatElapsed(elapsed)} ago)`;
        } else if (s < 3600) {
          if (s % 60 === 0) {
            watchdogInfo.textContent = `(updated ${formatElapsed(elapsed)} ago)`;
          }
        } else {
          if (s % 3600 === 0) {
            watchdogInfo.textContent = `(updated ${formatElapsed(elapsed)} ago)`;
            clearInterval(watchdogTimer);
            setMode("modeUnknown"); // watchdog fully stopped
          }
        }

        if (s >= 12 && s < 3600) {
          if (mode === "on" || mode === "on-pending") setMode("on-expired");
          else if (mode === "off" || mode === "off-pending") setMode("off-expired");
        }
      }, 1000);
    }

    function setRelayUI(relay, mode) {
      const el = document.getElementById("relay" + relay);
      const status = document.getElementById("relay" + relay + "Status");
      el.className = "v-switch " + mode;
      el.dataset.mode = mode;
      status.textContent =
        mode === "on" ? "Always On" :
        mode === "pid" ? "PID Controlled" :
        mode === "off" ? "Always Off" :
        "Unknown";
    }

    function cycleRelay(relay) {
      const el = document.getElementById("relay" + relay);
      const modes = ["on", "pid", "off"];
      let idx = modes.indexOf(el.dataset.mode);
      if (idx < 0) idx = 0;
      idx = (idx + 1) % modes.length;
      const newMode = modes[idx];
      setRelayUI(relay, newMode);
      ws.send("relay:" + relay + ":" + newMode);
    }

    window.onload = () => {
      document.getElementById("selflink").href = window.location.href;

      ws = new WebSocket("ws://" + window.location.host + "/ws");

      ws.onopen = () => console.log("WebSocket connected");

      ws.onmessage = (event) => {
        console.log("Message:", event.data);
        try {
          const data = JSON.parse(event.data);
          document.getElementById("currentTemp").textContent = data.temp.toFixed(1);
          document.getElementById("targetTemp").value = data.target.toFixed(1);
	  if (data.relayModes) {
            const map = ["off", "pid", "on"]; // 0=off, 1=pid, 2=on
            for (let i = 0; i < 3; i++) {
              const st = map[data.relayModes[i]] || "modeUnknown";
              setRelayUI(i+1, st);
            }
          }
          lastUpdate = Date.now();
          if (data.enabled) setMode("on");
          else setMode("off");
          refreshWatchdog();
        } catch (e) {
          console.error("Parse error:", e);
        }
      };

      document.getElementById("powerToggle").onchange = (ev) => {
        if (ev.target.checked) {
          ws.send("enable");
          setMode("on-pending");
        } else {
          ws.send("disable");
          setMode("off-pending");
        }
      };

      document.getElementById("targetTemp").onchange = () => {
        const val = document.getElementById("targetTemp").value;
        ws.send("target:" + val);
      };

      setMode("modeUnknown");
      refreshWatchdog();
    };

  </script>
</head>
<body>
  <p><a id="selflink" href="#">Reload page</a></p>
  <h1>Sauna Control</h1>
  <table>
    <tr>
      <td>Power:</td>
      <td>
        <label id="powerWrap" class="switch modeUnknown">
          <input type="checkbox" id="powerToggle">
          <span class="slider"></span>
        </label>
      </td>
      <td>Status: <span id="status" class="status modeUnknown">Unknown</span> <span id="watchdog" style="font-style:italic; color:gray;"></span></td>
    </tr>
    <tr>
      <td>Target temperature:</td>
      <td><input type="number" id="targetTemp" step="0.5" min="0" max="120"> °C</td>
      <td>Current: <span id="currentTemp">--</span> °C</td>
    </tr>
    <tr>
      <td>Phase switches:</td>
      <td>
      	<table>
	  <tr>
	    <td>
  	      <div class="v-switch modeUnknown" id="relay1" onclick="cycleRelay(1)">
	      	<div class="knob"></div>
	      </div>
	    </td>
	    <td>
  	      <div class="v-switch modeUnknown" id="relay2" onclick="cycleRelay(2)">
	      	<div class="knob"></div>
	      </div>
	    </td>
	    <td>
  	      <div class="v-switch modeUnknown" id="relay3" onclick="cycleRelay(3)">
	      	<div class="knob"></div>
	      </div>
	    </td>
	  </tr>
	</table>
      </td>
      <td>
	      <p>Relay 1: <span id="relay1Status">Unknown</span></p>
	      <p>Relay 2: <span id="relay2Status">Unknown</span></p>
	      <p>Relay 3: <span id="relay3Status">Unknown</span></p>
      </td>
    </tr>
  </table>
</body>
</html>

